<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>eLearning - Course Details</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; transition: background 0.3s, color 0.3s; }
    body.dark-mode { background:#1c1c1c; color:#f0f0f0; }
    header { background:#2c3e50; color:white; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
    header a { color:#f1c40f; text-decoration:none; margin-left:1rem; }
    body.dark-mode header { background:#111; color:#f0f0f0; }
    main { padding:2rem; }
    .lesson { border:1px solid #ddd; border-radius:6px; padding:1rem; margin-bottom:1rem; background:#fafafa; transition: background 0.3s, color 0.3s, border-color 0.3s; }
    body.dark-mode .lesson { background:#2c2c2c; color:#f0f0f0; border-color:#555; }
    .lesson h4 { margin-top:0; cursor:pointer; }
    .lesson-content { display:none; padding-top:0.5rem; overflow:hidden; transition: all 0.3s ease; }
    .completed { text-decoration:line-through; color:#888; }
    body.dark-mode .completed { color:#aaa; }
    .progress-container { background:#eee; border-radius:10px; margin:1rem 0; height:25px; width:100%; position:relative; transition: background 0.3s; }
    body.dark-mode .progress-container { background:#333; }
    .progress-bar { height:100%; background:#2ecc71; width:0%; border-radius:10px; transition:width 0.3s; position:relative; }
    body.dark-mode .progress-bar { background:#4cd137; }
    #progress-text { position:absolute; left:50%; transform:translateX(-50%); color:#fff; font-weight:bold; }
    .lesson-notes { margin-top:0.5rem; padding:0.5rem; width:100%; border-radius:5px; border:1px solid #ccc; resize:vertical; transition: background 0.3s, color 0.3s, border-color 0.3s; }
    body.dark-mode .lesson-notes { background:#3a3a3a; color:#f0f0f0; border-color:#555; }
    #toggle-all-btn { margin-bottom:1rem; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; background:#3498db; color:white; transition: background 0.3s; }
    body.dark-mode #toggle-all-btn { background:#2980b9; }
    video { max-width:100%; border-radius:6px; margin-top:0.5rem; background:#000; }
    body.dark-mode video { background:#111; }
    #dark-toggle { position:fixed; bottom:20px; right:20px; padding:10px 15px; border:none; border-radius:8px; cursor:pointer; background:#2c3e50; color:#fff; z-index:1000; transition: background 0.3s, color 0.3s; }
    body.dark-mode #dark-toggle { background:#111; color:#f0f0f0; }
  </style>
</head>
<body>
  <header>
    <h1>eLearning Platform</h1>
    <div>
      <a href="index.html">Home</a>
      <a href="#" onclick="logoutUser()">Logout</a>
    </div>
  </header>

  <main>
    <h2 id="course-title">Loading...</h2>
    <p id="course-description"></p>

    <div class="progress-container">
      <div class="progress-bar" id="course-progress">
        <span id="progress-text">0%</span>
      </div>
    </div>

    <button id="toggle-all-btn">Expand/Collapse All Lessons</button>
    <div id="lessons">Loading lessons...</div>
  </main>

  <button id="dark-toggle">🌙 Dark Mode</button>

  <script src="./assets/js/main.js"></script>
  <script>
    // Initialize Dark Mode
    const darkToggle = document.getElementById("dark-toggle");
    if(localStorage.getItem("dark-mode") === "enabled") {
      document.body.classList.add("dark-mode");
      darkToggle.innerText = "☀️ Light Mode";
    }
    darkToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      if(document.body.classList.contains("dark-mode")) {
        localStorage.setItem("dark-mode","enabled");
        darkToggle.innerText = "☀️ Light Mode";
      } else {
        localStorage.setItem("dark-mode","disabled");
        darkToggle.innerText = "🌙 Dark Mode";
      }
    });

    async function loadCourse() {
      const params = new URLSearchParams(window.location.search);
      const courseId = params.get("id");
      if (!courseId) return;

      try {
        const res = await authFetch(`/courses/${courseId}`);
        if (!res) return;
        const course = await res.json();
        if (!res.ok) throw new Error(course.message || "Unable to load course.");

        document.getElementById("course-title").innerText = course.title || "Untitled Course";
        document.getElementById("course-description").innerText = course.description || "";

        const lessonsEl = document.getElementById("lessons");
        const completedLessons = JSON.parse(localStorage.getItem("completedLessons") || "[]");

        lessonsEl.innerHTML = course.lessons
          .sort((a,b) => (a.order||0)-(b.order||0))
          .map((lesson, idx, arr) => `
            <div class="lesson ${completedLessons.includes(lesson._id) ? "completed" : ""}">
              <h4>${lesson.title}</h4>
              <div class="lesson-content">
                <p>${lesson.content || ""}</p>
                ${lesson.videoUrl ? `<video data-src="${lesson.videoUrl}" controls></video>` : ""}
                <div>
                  <input type="checkbox" class="complete-lesson" data-id="${lesson._id}" ${completedLessons.includes(lesson._id) ? "checked" : ""}>
                  Completed
                </div>
                <textarea class="lesson-notes" data-id="${lesson._id}" placeholder="Your notes...">${localStorage.getItem(`notes-${lesson._id}`)||""}</textarea>
              </div>
            </div>
          `).join("");

        const lessonElems = document.querySelectorAll(".lesson");

        // Toggle lesson content & lazy load videos
        lessonElems.forEach((lesson, idx) => {
          const header = lesson.querySelector("h4");
          const content = lesson.querySelector(".lesson-content");
          const video = content.querySelector("video");

          header.addEventListener("click", () => {
            if(content.style.display === "none") {
              content.style.display = "block";
              if(video && !video.src) video.src = video.dataset.src;
              document.querySelectorAll("video").forEach(v => { if(v!==video) v.pause(); });
            } else {
              content.style.display = "none";
              if(video) video.pause();
            }
          });

          // Auto play next lesson video
          if(video) {
            video.addEventListener("ended", () => {
              const nextLesson = lessonElems[idx + 1];
              if(nextLesson) {
                const nextContent = nextLesson.querySelector(".lesson-content");
                nextContent.style.display = "block";
                const nextVideo = nextContent.querySelector("video");
                if(nextVideo && !nextVideo.src) nextVideo.src = nextVideo.dataset.src;
                nextVideo?.play();
                nextLesson.scrollIntoView({ behavior: "smooth" });
              }
            });
          }
        });

        // Toggle all lessons
        document.getElementById("toggle-all-btn").addEventListener("click", () => {
          lessonElems.forEach(lesson => {
            const content = lesson.querySelector(".lesson-content");
            const video = content.querySelector("video");
            if(content.style.display === "none") {
              content.style.display = "block";
              if(video && !video.src) video.src = video.dataset.src;
            } else {
              content.style.display = "none";
              if(video) video.pause();
            }
          });
        });

        // Mark lessons completed
        document.querySelectorAll(".complete-lesson").forEach(checkbox => {
          checkbox.addEventListener("change", e => {
            const id = e.target.dataset.id;
            let completed = JSON.parse(localStorage.getItem("completedLessons") || "[]");
            if (e.target.checked) { completed.push(id); checkbox.closest(".lesson").classList.add("completed"); }
            else { completed = completed.filter(x=>x!==id); checkbox.closest(".lesson").classList.remove("completed"); }
            localStorage.setItem("completedLessons", JSON.stringify(completed));
            updateProgressBar(course.lessons, completed);
          });
        });

        // Lesson notes
        document.querySelectorAll(".lesson-notes").forEach(ta => {
          ta.addEventListener("input", e => localStorage.setItem(`notes-${e.target.dataset.id}`, e.target.value));
        });

        updateProgressBar(course.lessons, completedLessons);

      } catch(err) {
        console.error(err);
        document.getElementById("course-title").innerText = "Error loading course";
        document.getElementById("lessons").innerHTML = "<p>Unable to load lessons.</p>";
      }
    }

    function updateProgressBar(lessons, completed) {
      const progressEl = document.getElementById("course-progress");
      const progressText = document.getElementById("progress-text");
      const total = lessons.length;
      const done = lessons.filter(l=>completed.includes(l._id)).length;
      const percent = total ? Math.round((done/total)*100) : 0;
      progressEl.style.width = percent+"%";
      progressText.innerText = percent+"%";
    }

    document.addEventListener("DOMContentLoaded", loadCourse);
  </script>
</body>
</html>
